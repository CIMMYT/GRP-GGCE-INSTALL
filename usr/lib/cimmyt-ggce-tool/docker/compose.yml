services:
  ggce-traefik:
    image: traefik:v2.11
    container_name: ggce-traefik
    restart: always
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global HTTP to HTTPS redirection
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt configuration
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true" # Use http-01 challenge
      - "--certificatesresolvers.myresolver.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Dashboard de Traefik (para depuraci√≥n)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ggce-traefik-data:/letsencrypt
    networks:
      - ggce-network

  ggce-mssql:
    image: mcr.microsoft.com/mssql/server:2022-CU19-ubuntu-22.04
    container_name: ggce-mssql
    restart: always
    user: root
    ports:
      - "1433:1433"
    command:
    env_file:
      - path: /etc/cimmyt-ggce-tool/config.env
    environment:
      ACCEPT_EULA: 'Y'
      MSSQL_SA_PASSWORD: '${SA_PASSWORD}'
      MSSQL_PID: '${MSSQL_PID}'
      SA_PASSWORD: '${SA_PASSWORD}'
      TZ: UTC
      MSSQL_COLLATION: SQL_Latin1_General_CP1_CI_AS
    volumes:
      - ggce-database-store:/var/opt/mssql/data
      - ggce-database-log:/var/opt/mssql/log
      - ${FOLDER_STORE_GGCE}/mssql/dump:/var/opt/mssql/dump
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P "$SA_PASSWORD" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ggce-network
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT_MSSQL:-8g}

  ggce-mssql-client:
    build:
      context: ./mssql-client
      dockerfile: Dockerfile
    container_name: ggce-mssql-client
    env_file:
      - path: /etc/cimmyt-ggce-tool/config.env
    environment:
      SA_PASSWORD: '${SA_PASSWORD}'
      USER_DB: '${USER_DB}'
      PASSWORD_DB: '${PASSWORD_DB}'
      DB_NAME: '${DB_NAME}'
    depends_on:
      ggce-mssql:
        condition: service_healthy # Wait for mssql to be healthy
    volumes:
      - ggce-data-api:/var/opt/mssql/dump:ro
    networks:
      - ggce-network

  ggce-api:
    image: dockerhub.croptrust.org/grin-global/grin-global-server:${GG_CE_API_VERSION}
    container_name: ggce-api
    env_file:
      - path: /etc/cimmyt-ggce-tool/config.env
    environment:
      # Database connection
      - DB_URL=jdbc:sqlserver://ggce-mssql:1433;DatabaseName=${DB_NAME}
      - DB_USERNAME=${USER_DB}
      - DB_PASSWORD=${PASSWORD_DB}
      # GGCE URLs
      - BASE_URL=${API_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      # Advanced options
      - CACHE_LIBRARY=ehcache
      - JAVA_OPTIONS=-Xlog:gc -XX:+UseG1GC -XX:MinRAMPercentage=50.0 -XX:MaxRAMPercentage=90.0 -Djava.awt.headless=true -server -Dnetworkaddress.cache.ttl=60 -Dcom.sun.security.enableAIAcaIssuers=true --add-modules java.se --add-exports java.base/jdk.internal.ref=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.management/sun.management=ALL-UNNAMED --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED
    volumes:
      - ${FOLDER_STORE_GGCE}/api-data:/data/gringlobal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ggce-api.rule=Host(`${API_URL}`)"
      - "traefik.http.routers.ggce-api.entrypoints=websecure"
      - "traefik.http.routers.ggce-api.tls.certresolver=myresolver"
      - "traefik.http.services.ggce-api.loadbalancer.server.port=8080"
    networks:
      ggce-network:
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT_API:-4g}
    restart: unless-stopped
    depends_on:
      - ggce-mssql
  ggce-ui:
    image: dockerhub.croptrust.org/grin-global/grin-global-ui/gg-ce-web:${GG_CE_UI_VERSION}
    container_name: ggce-ui
    env_file:
      - path: /etc/cimmyt-ggce-tool/config.env
    environment:
      - API_URL=${API_URL}
      - API_URL_INTERNAL=http://ggce-api:8080
      - ORIGIN=${FRONTEND_URL}
      - NAME=Germplasm Bank
      - NAME_SHORT=BANK
      - 'MENU_COLOR=#477628'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ggce-ui.rule=Host(`${FRONTEND_URL}`)"
      - "traefik.http.routers.ggce-ui.entrypoints=websecure"
      - "traefik.http.routers.ggce-ui.tls.certresolver=myresolver"
      - "traefik.http.services.ggce-ui.loadbalancer.server.port=3000"
    networks:
      ggce-network:
    depends_on:
      - ggce-api
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT_UI:-500m}
    restart: unless-stopped

  ggce-version-tracker:
    build:
      context: ./version-tracker
      dockerfile: Dockerfile
    container_name: ggce-version-tracker
    env_file:
      - path: /etc/cimmyt-ggce-tool/config.env
    volumes:
      - /etc/cimmyt-ggce-tool/version-tracker:/app/data
    networks:
      - ggce-network

networks:
  ggce-network:
    external: true
volumes:
  ggce-database-store:
    external: true
  ggce-database-log:
    external: true
  ggce-data-api:
    external: true
  ggce-traefik-data:
    external: true




    